<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat Application</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .auth-section, .chat-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        input, button, select {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        .chat-layout {
            display: flex;
            gap: 20px;
        }

        .users-panel {
            width: 200px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 400px;
        }

        .chat-panel {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        .message.sent {
            background-color: #e3f2fd;
            text-align: right;
        }

        .message.received {
            background-color: #f1f8e9;
        }

        .message-meta {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
        }

        .online-users {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .online-users li {
            padding: 5px 10px;
            margin: 2px 0;
            background-color: #e8f5e8;
            border-radius: 4px;
            cursor: pointer;
        }

        .online-users li:hover {
            background-color: #d4edda;
        }

        .online-users li.selected {
            background-color: #007bff;
            color: white;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background-color: #cce7ff;
            color: #004085;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>WebSocket Chat Application</h1>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <h2>Login / Register</h2>
        <div>
            <input type="text" id="username" placeholder="Username" maxlength="50">
            <input type="password" id="password" placeholder="Password" maxlength="100">
            <button onclick="login()">Login</button>
            <button onclick="register()">Register</button>
        </div>
        <div id="authStatus" class="status hidden"></div>
    </div>

    <!-- Chat Section -->
    <div id="chatSection" class="chat-section hidden">
        <h2>Chat - Welcome <span id="currentUser"></span></h2>
        <div class="chat-layout">
            <!-- Online Users Panel -->
            <div class="users-panel">
                <h3>Online Users</h3>
                <ul id="onlineUsers" class="online-users"></ul>
                <div id="selectedUser" style="margin-top: 10px; font-weight: bold;"></div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-panel">
                <div id="messages" class="messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Type your message..." maxlength="1000">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
        <div id="chatStatus" class="status hidden"></div>
        <button onclick="logout()" style="margin-top: 10px;">Logout</button>
    </div>
</div>

<script>
        let socket = null;
        let currentUsername = null;
        let selectedRecipient = null;

        // Authentication functions
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showAuthStatus('Please enter both username and password', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUsername = data.username;
                    showAuthStatus('Login successful!', 'success');
                    connectWebSocket();
                    showChatSection();
                } else {
                    showAuthStatus(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAuthStatus('Network error during login', 'error');
            }
        }

        async function register() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showAuthStatus('Please enter both username and password', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showAuthStatus('Registration successful! You can now login.', 'success');
                } else {
                    showAuthStatus(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthStatus('Network error during registration', 'error');
            }
        }

        function logout() {
            if (socket) {
                socket.close();
            }
            currentUsername = null;
            selectedRecipient = null;
            showAuthSection();
            clearMessages();
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // WebSocket functions
        function connectWebSocket() {
            const socketUrl = window.location.protocol === 'https:' ? 'https://' : 'http://';
            const baseUrl = socketUrl + window.location.host + '/websocket/chat';

            socket = new SockJS(baseUrl);

            socket.onopen = function() {
                console.log('WebSocket connected');
                // Authenticate with the server
                socket.send(JSON.stringify({
                    type: 'authenticate',
                    username: currentUsername
                }));
                showChatStatus('Connected to chat server', 'success');
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            socket.onclose = function() {
                console.log('WebSocket disconnected');
                showChatStatus('Disconnected from chat server', 'error');
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                showChatStatus('Connection error', 'error');
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'auth_success':
                    showChatStatus('Authentication successful', 'success');
                    requestOnlineUsers();
                    break;
                case 'message':
                    displayMessage(data.sender, data.content, data.timestamp, false);
                    break;
                case 'message_sent':
                    showChatStatus(`Message sent to ${data.recipient} ${data.delivered ? '(delivered)' : '(will be delivered when online)'}`, 'info');
                    break;
                case 'online_users':
                    updateOnlineUsers(data.users);
                    break;
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content || !selectedRecipient) {
                showChatStatus('Please select a recipient and enter a message', 'error');
                return;
            }

            if (!socket || socket.readyState !== SockJS.OPEN) {
                showChatStatus('Not connected to chat server', 'error');
                return;
            }

            socket.send(JSON.stringify({
                type: 'chat',
                recipient: selectedRecipient,
                content: content
            }));

            displayMessage(currentUsername, content, new Date().toISOString(), true);
            messageInput.value = '';
        }

        function requestOnlineUsers() {
            if (socket && socket.readyState === SockJS.OPEN) {
                socket.send(JSON.stringify({
                    type: 'get_users'
                }));
            }
        }

        // UI functions
        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('chatSection').classList.add('hidden');
        }

        function showChatSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('chatSection').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUsername;
        }

        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            setTimeout(() => statusDiv.classList.add('hidden'), 5000);
        }

        function showChatStatus(message, type) {
            const statusDiv = document.getElementById('chatStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            setTimeout(() => statusDiv.classList.add('hidden'), 3000);
        }

        function displayMessage(sender, content, timestamp, isSent) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

            const time = new Date(timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <div class="message-meta">${sender} - ${time}</div>
                <div>${escapeHtml(content)}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateOnlineUsers(users) {
            const usersList = document.getElementById('onlineUsers');
            usersList.innerHTML = '';

            users.forEach(user => {
                if (user !== currentUsername) {
                    const li = document.createElement('li');
                    li.textContent = user;
                    li.onclick = () => selectUser(user);
                    usersList.appendChild(li);
                }
            });
        }

        function selectUser(username) {
            selectedRecipient = username;
            document.getElementById('selectedUser').textContent = `Chat with: ${username}`;

            // Update UI selection
            document.querySelectorAll('.online-users li').forEach(li => {
                li.classList.remove('selected');
                if (li.textContent === username) {
                    li.classList.add('selected');
                }
            });
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>